<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Shadowing Player Ultimate</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
    /* --- 1. åŸºç¡€é‡ç½® --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; background: #121212; color: #eee; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    
    button { border: none; outline: none; background: #333; color: #ccc; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 13px; transition: 0.2s; }
    button:active { background: #555; }
    input { background: #000; border: 1px solid #333; color: #fff; text-align: center; border-radius: 4px; outline: none; }

    /* --- 2. å“åº”å¼å¸ƒå±€ --- */
    #app { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }

    @media (min-width: 768px) {
        #app { flex-direction: row; }
        .video-wrapper { width: 50%; height: 100% !important; border-right: 1px solid #333; border-bottom: none !important; }
        .content-wrapper { width: 50%; height: 100%; }
        .top-toolbar { padding: 5px 15px; }
    }

    /* --- 3. é¡¶éƒ¨å·¥å…·æ  --- */
    .top-toolbar {
        height: 44px; background: #1f1f1f; display: flex; align-items: center; padding: 0 8px; gap: 6px; border-bottom: 1px solid #000; flex-shrink: 0; overflow-x: auto; white-space: nowrap;
    }
    .tool-btn {
        height: 30px; padding: 0 10px; background: #2a2a2a; color: #ddd; flex: 1; min-width: auto; font-size: 13px;
    }
    .tool-btn.active { background: #1565C0; color: white; }

    /* --- 4. è§†é¢‘åŒºåŸŸ --- */
    .video-wrapper { display: flex; flex-direction: column; flex-shrink: 0; border-bottom: 1px solid #333; }
    .video-area { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; position: relative; min-height: 220px; }
    video, audio { width: 100%; height: 100%; max-height: 100%; }
    #placeholder { color: #444; font-size: 14px; }

    /* --- 5. AB å¾ªç¯æ¡ --- */
    .loop-bar { height: 44px; background: #111; display: flex; align-items: center; justify-content: center; gap: 6px; border-top: 1px solid #222; flex-shrink: 0; }
    .circle-btn { width: 32px; height: 32px; border-radius: 50%; background: #222; border: 1px solid #333; color: #888; }
    .loop-input { width: 50px; height: 26px; font-size: 12px; border: 1px solid #333; background: #000; }
    .btn-loop-active { background: #1565C0; color: #fff; border: none; }
    .btn-close-loop { color: #f44336; }

    /* --- 6. å†…å®¹åŒº (å…³é”®ä¿®å¤ï¼šFlexå¸ƒå±€ç¡®ä¿æ»šåŠ¨) --- */
    .content-wrapper { flex: 1; overflow: hidden; position: relative; background: #121212; display: flex; flex-direction: column; }
    
    #page-subs { width: 100%; height: 100%; overflow-y: auto; display: none; padding-bottom: 10px; }
    
    /* å­¦ä¹ é¡µå¿…é¡»æ˜¯ flex column æ‰èƒ½è®©åˆ—è¡¨æ»šåŠ¨ */
    #page-study { width: 100%; height: 100%; display: flex; flex-direction: column; }
    
    .study-tabs { height: 40px; display: flex; background: #1a1a1a; border-bottom: 1px solid #333; flex-shrink: 0; }
    .tab-item { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 13px; color: #888; border-right: 1px solid #222; cursor: pointer; }
    .tab-item.active { color: #fff; border-bottom: 2px solid #4CAF50; background: #222; font-weight: bold; }
    .save-icon-btn { flex: 0.5; color: #b39ddb; font-size: 18px; border-right: none; } 

    /* åˆ—è¡¨å®¹å™¨ï¼šflex:1 è‡ªåŠ¨æ’‘æ»¡å‰©ä½™ç©ºé—´å¹¶æ»šåŠ¨ */
    .list-container { flex: 1; overflow-y: auto; padding: 0; display: none; }
    .list-container.show { display: block; }
    
    .empty-tip { text-align: center; color: #444; margin-top: 50px; font-size: 13px; }

    /* --- 7. åº•éƒ¨å¯¼èˆª --- */
    .bottom-nav { height: 50px; background: #1a1a1a; border-top: 1px solid #000; display: flex; flex-shrink: 0; z-index: 10; }
    .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; color: #666; font-size: 10px; cursor: pointer; }
    .nav-btn.active { color: #FFC107; }
    .nav-icon { font-size: 20px; margin-bottom: 1px; }

    /* --- 8. å­—å¹•è¡Œæ ·å¼ --- */
    .tp-row { padding: 12px 10px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; cursor: default; }
    .tp-row.active { background: #1e1e1e; border-left: 4px solid #4CAF50; }
    
    .tp-left-col { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 10px; width: 30px; }
    .star-btn { color: #555; font-size: 18px; cursor: pointer; padding: 5px; }
    .star-btn:hover { color: #FFC107; }
    
   .tp-text-group { 
    flex: 1; 
    margin-right: 10px; 
    display: flex; 
    flex-direction: column; 
    overflow-wrap: break-word; /* å…³é”®ï¼šé˜²æ­¢æ—¥æ–‡é•¿å¥æ’‘ç ´å®¹å™¨ */
    word-break: break-word;    /* å…³é”® */
}
    .tp-top-line { font-size: 16px; color: #eee; margin-bottom: 6px; font-weight: 600; line-height: 1.4; transition: opacity 0.3s; }
    .tp-bottom-line { font-size: 14px; color: #888; line-height: 1.4; transition: opacity 0.3s; }
    
   .word-click { 
    cursor: pointer; 
    padding: 1px 2px; /* ç¨å¾®å¢åŠ ç‚¹å‡»é¢ç§¯ */
    border-radius: 3px; 
    border-bottom: 1px solid transparent; 
    display: inline-block; /* ä¿è¯ padding ç”Ÿæ•ˆ */
}
    .word-click:hover { background: #333; }
    .word-click:active { background: #4CAF50; color: #fff; }
    
    .tp-play-small { width: 32px; height: 32px; border-radius: 50%; background: #2a2a2a; color: #aaa; flex-shrink: 0; font-size: 12px; border: 1px solid #333; }
    .tp-play-small:active { background: #4CAF50; color: white; }

    #page-subs.hide-top-mode .tp-top-line { opacity: 0; pointer-events: none; }
    #page-subs.hide-bottom-mode .tp-bottom-line { opacity: 0; }

    /* --- 9. ç”Ÿè¯/ç¬”è®° --- */
    .fav-item { padding: 12px; border-bottom: 1px solid #222; position: relative; background: #181818; margin-bottom: 1px; }
    .fav-word { color: #4CAF50; font-weight: bold; font-size: 16px; margin-bottom: 6px; display: block; }
    .fav-input { width: 100%; background: #000; border: 1px solid #333; color: #aaa; font-size: 14px; padding: 8px; border-radius: 4px; text-align: left; }
    .del-btn { position: absolute; right: 15px; top: 12px; color: #d32f2f; font-size: 18px; cursor: pointer; }
    
    textarea.notebook { width: 100%; height: 100%; background: #121212; color: #ddd; border: none; padding: 20px; resize: none; font-size: 15px; line-height: 1.6; outline: none; }

    /* --- 10. å¼¹çª— --- */
    #hoverTip { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 320px; background: #222; padding: 20px; border-radius: 8px; box-shadow: 0 0 30px rgba(0,0,0,0.9); z-index: 200; border: 1px solid #444; }
    #lockScreen { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:999; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    
    #modalExport { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 300; align-items:center; justify-content:center; }
    .modal-box { width: 85%; max-width: 320px; background: #222; padding: 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
    .export-btn { width: 100%; padding: 12px; margin-bottom: 10px; background: #333; color: #fff; text-align: left; font-size: 14px; border-radius: 4px; display: flex; align-items: center; }
    
    .api-status-bar { margin-bottom: 15px; padding: 10px; background: #111; border-radius: 4px; font-size: 13px; color: #666; text-align: center; border: 1px dashed #333; }
    .api-status-bar.ok { color: #4CAF50; border-color: #4CAF50; font-weight: bold; background: rgba(76, 175, 80, 0.1); }

    #printArea { display: none; }
@media print {
        body > * { display: none !important; }
        #printArea { display: block !important; background: white; color: black; padding: 20px; font-family: "Times New Roman", serif; }
        /* æ ‡é¢˜æ”¹å° */
        h1 { border-bottom: 1px solid #000; padding-bottom: 5px; font-size: 16pt; margin: 0 0 10px 0; }
        h2 { margin-top: 12px; background: #f0f0f0; padding: 4px; font-size: 8pt; }
        /* è¡¨æ ¼ç´§å‡‘ï¼Œå­—å·æ”¹å° */
        table { width: 100%; border-collapse: collapse; margin-top: 4px; }
        th, td { border: 1px solid #666; padding: 4px 6px; text-align: left; vertical-align: top; font-size: 6pt; }
        .col-word { width: 20%; font-weight: bold; }
        .col-note { width: 50%; }
        .col-blank { width: 30%; }
    }
/* --- ç”µè„‘ç‰ˆå¸ƒå±€è¡¥ä¸ï¼šå·¦è¾¹æ˜¾ç¤ºç¬”è®°ï¼Œå³è¾¹æ˜¾ç¤ºå­—å¹• --- */
    @media (min-width: 768px) {
        /* 1. å¼ºåˆ¶å·¦å³ä¸¤è¾¹çš„å†…å®¹éƒ½æ˜¾ç¤º (æ— è§† display:none) */
        #page-subs, #page-study { 
            display: flex !important; 
            flex: 1; 
            height: auto !important; 
            overflow: hidden;
        }
        /* 2. éšè—åº•éƒ¨çš„æ‰‹æœºå¯¼èˆªæ  (ç”µè„‘ä¸éœ€è¦) */
        .bottom-nav { display: none !important; }
        
        /* 3. è®©å·¦ä¾§å®¹å™¨èƒ½æ’‘å¼€é«˜åº¦ */
        .video-wrapper { height: 100vh !important; }
        
        /* 4. å¾®è°ƒåˆ—è¡¨åŒºåŸŸï¼Œè®©å®ƒåœ¨ç”µè„‘ä¸Šå æ»¡å‰©ä½™ç©ºé—´ */
        .list-container { height: 100%; overflow-y: auto; }
        
        /* 5. éšè—æ‰‹æœºç‰ˆæ˜¾éšé€»è¾‘äº§ç”Ÿçš„å†²çªç±» */
        .hidden { display: none !important; }
    }
</style>
</head>
<body>

    <div id="lockScreen">
        <h3 style="color:#4CAF50; margin-bottom:10px;">Security Lock</h3>
        <div id="deviceUID" onclick="copyUID()" style="font-family:monospace; color:#666; margin-bottom:20px; border:1px dashed #333; padding:10px; cursor: pointer;">UID LOADING...</div>
        <input type="text" id="lockInput" placeholder="è¯·è¾“å…¥æ¿€æ´»ç " style="padding:10px; width:200px; margin-bottom:15px; text-align:center;">
        <button onclick="unlockApp()" style="width:200px; padding:12px; background:#1565C0; color:white; font-size:14px;">è§£é”è¿›å…¥</button>
        <div id="lockMsg" style="margin-top:20px; color:#666; font-size:12px;">åˆå§‹åŒ–ä¸­...</div>
    </div>

    <div id="hoverTip">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #444; padding-bottom:5px;">
            <span id="popWord" style="color:#4CAF50; font-weight:bold; font-size:18px;">Word</span>
            <span onclick="document.getElementById('hoverTip').style.display='none'" style="cursor:pointer; color:#888; font-size: 20px;">âœ•</span>
        </div>
        <div id="popDef" style="color:#ccc; font-size:14px; min-height:80px; line-height:1.6;">æŸ¥è¯¢ä¸­...</div>
        <button onclick="saveFromPop()" style="width:100%; margin-top:15px; background:#1565C0; color:white; padding:10px; font-size:14px;">åŠ å…¥å•è¯æœ¬</button>
    </div>

    <div id="modalExport">
        <div class="modal-box">
            <h3 style="margin-top:0; color:#ddd; font-size:16px; border-bottom:1px solid #444; padding-bottom:10px;">æ•°æ®å¯¼å‡º</h3>
            <div id="exportApiStatus" class="api-status-bar">æ£€æµ‹æœåŠ¡...</div>
            <button class="export-btn" onclick="doExport('pdf')">ğŸ“„ PDF (æ‰“å°ç‰ˆ)</button>
            <button class="export-btn" onclick="doExport('excel')">ğŸ“Š Excel è¡¨æ ¼</button>
            <button class="export-btn" onclick="doExport('txt')">ğŸ“ TXT æ–‡æœ¬</button>
            <button class="export-btn" onclick="doExport('backup')">ğŸ’¾ å¤‡ä»½æ–‡ä»¶</button>
            <div style="border-top:1px dashed #444; margin-top:15px; padding-top:15px;">
                <div style="color:#888; font-size:12px; margin-bottom:5px;">æ¢å¤æ•°æ®:</div>
                <input type="file" id="importFile" accept=".json" style="width:100%; margin-bottom:5px;">
                <button onclick="importBackup()" style="width:100%; background:#1565C0; padding:10px; color:white;">å¯¼å…¥</button>
            </div>
            <button onclick="document.getElementById('modalExport').style.display='none'" style="width:100%; background:transparent; color:#888; margin-top:15px;">å…³é—­</button>
        </div>
    </div>

    <div id="printArea"></div>

    <div id="app">
        <div class="top-toolbar">
            <button class="tool-btn" onclick="document.getElementById('fVid').click()">
                <span class="icon-yellow">ğŸ“‚</span> è§†é¢‘
            </button>
            <button class="tool-btn" onclick="document.getElementById('fSub').click()">
                <span class="icon-file">ğŸ“</span> å­—å¹•
            </button>
            <button class="tool-btn" onclick="swapTextLines()" title="å†…å®¹äº’æ¢">
                <span>â‡… äº¤æ¢</span>
            </button>
            <button class="tool-btn" onclick="toggleLine('top')" id="btnHideTop">
                <span>ğŸ‘ï¸ ä¸Šå¥</span>
            </button>
            <button class="tool-btn" onclick="toggleLine('bottom')" id="btnHideBot">
                <span>ğŸ‘ï¸ ä¸‹å¥</span>
            </button>
            <input type="file" id="fVid" style="display:none" accept="video/*,audio/*">
            <input type="file" id="fSub" style="display:none" accept=".srt,.ass">
        </div>

        <div class="video-wrapper" id="videoWrapper">
            <div class="video-area">
                <div id="placeholder">è¯·å¯¼å…¥è§†é¢‘</div>
                <video id="vid" style="display:none" playsinline controls></video>
                <audio id="aud" style="display:none" controls></audio>
            </div>
            <div class="loop-bar">
                <button class="circle-btn" onclick="setA()">A</button>
                <input id="inA" class="loop-input" value="0.0">
                <span style="color:#444">-</span>
                <input id="inB" class="loop-input" value="0.0">
                <button class="circle-btn" onclick="setB()">B</button>
                <button class="circle-btn" id="btnLoop" onclick="toggleLoop()" style="border-radius:4px; width:auto; padding:0 8px;">ğŸ”</button>
                <button class="circle-btn btn-close-loop" onclick="clearLoop()">Ã—</button>
            </div>
        </div>

        <div class="content-wrapper" id="contentWrapper">
            <div id="page-subs">
                <div class="empty-tip">æš‚æ— å­—å¹•</div>
            </div>

            <div id="page-study" style="display:none;">
                <div class="study-tabs">
                    <div class="tab-item active" onclick="switchNoteTab('words')">å•è¯</div>
                    <div class="tab-item" onclick="switchNoteTab('sents')">å¥åº“</div>
                    <div class="tab-item" onclick="switchNoteTab('notes')">ç¬”è®°</div>
                    <div class="tab-item save-icon-btn" onclick="document.getElementById('modalExport').style.display='flex'">ğŸ’¾</div>
                </div>
                
                <div id="tab-content-words" class="list-container show">
                    <div class="empty-tip">æš‚æ— å•è¯</div>
                </div>
                <div id="tab-content-sents" class="list-container">
                    <div class="empty-tip">æš‚æ— å¥å­</div>
                </div>
                <div id="tab-content-notes" class="list-container">
                    <textarea id="myNotebook" class="notebook" placeholder="åœ¨æ­¤è¾“å…¥ç¬”è®°å†…å®¹ (è‡ªåŠ¨ä¿å­˜)..." oninput="saveData()"></textarea>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-btn" id="nav-sub" onclick="navSwitch('sub')">
                <span class="nav-icon">ğŸ“</span>
                <span>å­—å¹•</span>
            </div>
            <div class="nav-btn active" id="nav-study" onclick="navSwitch('study')">
                <span class="nav-icon">ğŸ“’</span>
                <span>å­¦ä¹ è®°å½•</span>
            </div>
        </div>
    </div>

<script>
    const SECURE_DATA = {
        PASSPHRASE: "S", 
        ENCRYPTED_ID: "U2FsdGVkX1/mJtsgO2XnpSvOynudnE3UG3xu/u3elMgCUFUHk1RGnLwKZ97xlrST", 
        ENCRYPTED_KEY: "U2FsdGVkX1+HFdyRBVE2cKu0ucTm26Q2lcaXBEdp3H553gOh5q3dDCFgq2spntHD", 
        SALT: "MY_SECRET_SALT_2025"
    };
    let APP_CONFIG = { SALT: SECURE_DATA.SALT, baidu: { appid: '', key: '' } };
    let HAS_API = false;

    (function initSecurity() {
        try {
            if (typeof CryptoJS === 'undefined') return;
            const p = SECURE_DATA.PASSPHRASE;
            const i = CryptoJS.AES.decrypt(SECURE_DATA.ENCRYPTED_ID, p).toString(CryptoJS.enc.Utf8);
            const k = CryptoJS.AES.decrypt(SECURE_DATA.ENCRYPTED_KEY, p).toString(CryptoJS.enc.Utf8);
            if(i && k) { 
                APP_CONFIG.baidu.appid = i; 
                APP_CONFIG.baidu.key = k; 
                HAS_API = true;
            }
        } catch(e){ console.error(e); }
    })();

    let player = null;
    let subtitles = [];
    let favData = { words: [], sents: [], noteContent: "" };
    let currentFileKey = "default";
    let myUID = "";
    let loopStart=0, loopEnd=0, isLooping=false;
    let activeIndex = -1;
    let curHovWord = "";
    const vid = document.getElementById('vid');
    const aud = document.getElementById('aud');

    function initApp() {
        let s = localStorage.getItem("APP_UID");
        if(!s) { s = Math.random().toString(36).substring(2,8).toUpperCase(); localStorage.setItem("APP_UID", s); }
        myUID = s;
        document.getElementById('deviceUID').innerText = "UID: " + myUID;

        const msg = document.getElementById('lockMsg');
        const expStatus = document.getElementById('exportApiStatus');
        
        if(HAS_API) {
            msg.innerText = "âœ… ç™¾åº¦ç¿»è¯‘å·²å†…ç½®";
            msg.style.color = "#4CAF50";
            expStatus.innerText = "âœ… å·²æ¥å…¥ç™¾åº¦ç¿»è¯‘";
            expStatus.classList.add('ok');
        } else {
            msg.innerText = "âŒ æœªæ£€æµ‹åˆ°ç¿»è¯‘é…ç½®";
            expStatus.innerText = "âŒ æœªæ¥å…¥ç¿»è¯‘";
        }

        // æ£€æŸ¥æ¿€æ´»çŠ¶æ€ (è®°å¿†åŠŸèƒ½)
        if(localStorage.getItem("APP_ACTIVATED")==="true") {
            document.getElementById('lockScreen').style.display='none';
        }
        navSwitch('study');
    }

    function unlockApp() {
        const val = document.getElementById('lockInput').value.trim();
        let code = "123456"; 
        if(typeof CryptoJS !== 'undefined') {
            code = CryptoJS.MD5(myUID + SECURE_DATA.SALT).toString().substring(0,8);
        }
        if(val.toLowerCase() === code.toLowerCase()) {
            localStorage.setItem("APP_ACTIVATED", "true"); // å†™å…¥æœ¬åœ°å­˜å‚¨
            document.getElementById('lockScreen').style.display='none';
        } else { alert("æ¿€æ´»ç é”™è¯¯"); }
    }
    function copyUID() { navigator.clipboard.writeText(myUID).then(()=>alert("UIDå·²å¤åˆ¶")); }

    function navSwitch(page) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(page === 'sub') {
            document.getElementById('nav-sub').classList.add('active');
            document.getElementById('page-subs').style.display = 'block';
            document.getElementById('page-study').style.display = 'none';
        } else {
            document.getElementById('nav-study').classList.add('active');
            document.getElementById('page-subs').style.display = 'none';
            document.getElementById('page-study').style.display = 'flex';
            renderFavList();
        }
    }

    function switchNoteTab(tab) {
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        const tabs = document.querySelectorAll('.tab-item');
        if(tab==='words') tabs[0].classList.add('active');
        if(tab==='sents') tabs[1].classList.add('active');
        if(tab==='notes') tabs[2].classList.add('active');

        // ä½¿ç”¨ .show ç±»æ§åˆ¶æ˜¾ç¤ºï¼Œé…åˆ CSS çš„ display:none
        document.getElementById('tab-content-words').classList.remove('show');
        document.getElementById('tab-content-sents').classList.remove('show');
        document.getElementById('tab-content-notes').classList.remove('show');
        
        document.getElementById('tab-content-'+tab).classList.add('show');
    }

    function toggleLine(type) {
        const container = document.getElementById('page-subs');
        if(type === 'top') {
            container.classList.toggle('hide-top-mode');
            document.getElementById('btnHideTop').classList.toggle('active');
        }
        if(type === 'bottom') {
            container.classList.toggle('hide-bottom-mode');
            document.getElementById('btnHideBot').classList.toggle('active');
        }
    }
    
    function swapTextLines() {
        subtitles.forEach(s => { let t = s.f; s.f = s.n; s.n = t; });
        renderSubs(); 
    }

    document.getElementById('fVid').addEventListener('change', function(e){
        const f = e.target.files[0]; if(!f) return;
        currentFileKey = "SH_DATA_" + f.name;
        loadData();
        const url = URL.createObjectURL(f);
        document.getElementById('placeholder').style.display='none';
        vid.style.display='none'; aud.style.display='none';
        if(f.name.match(/\.(mp3|wav|m4a)$/i)) player = aud; else player = vid;
        player.style.display = 'block';
        player.src = url;
        player.ontimeupdate = onTick;
    });

    document.getElementById('fSub').addEventListener('change', function(e){
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = function(ev) {
            parseSRT(ev.target.result);
            renderSubs();
            navSwitch('sub');
            alert("âœ… å­—å¹•å¯¼å…¥æˆåŠŸ");
        };
        r.readAsText(f, 'UTF-8');
    });

   function parseSRT(txt) {
    subtitles = [];
    txt = txt.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
    const sections = txt.split(/\n\s*\n/); // æŒ‰ç©ºè¡Œåˆ†å‰²å­—å¹•å—

    sections.forEach(section => {
        const lines = section.split('\n');
        if (lines.length >= 2) {
            // æŸ¥æ‰¾æ—¶é—´è½´è¡Œ (åŒ…å« --> çš„é‚£ä¸€è¡Œ)
            const timeLineIdx = lines.findIndex(l => l.includes('-->'));
            if (timeLineIdx !== -1) {
                const timeStr = lines[timeLineIdx];
                const t = timeStr.split('-->');
                const s = parseTime(t[0]);
                const e = parseTime(t[1]);

                // æ—¶é—´è½´ä¹‹åçš„æ‰€æœ‰è¡Œè§†ä¸ºå­—å¹•å†…å®¹
                let contentLines = lines.slice(timeLineIdx + 1).filter(l => l.trim() !== '');
                
                let fT = "";
                let nT = "";

                if (contentLines.length === 1) {
                    // å¦‚æœåªæœ‰ä¸€è¡Œï¼Œå…¨éƒ¨ç»™ä¸Šé¢ï¼Œä¸‹é¢ç•™ç©º
                    fT = contentLines[0];
                } else if (contentLines.length >= 2) {
                    // ã€å…³é”®é€»è¾‘ã€‘ï¼šå¦‚æœæ˜¯åŒè¯­ï¼Œé»˜è®¤ç¬¬ä¸€è¡Œæ˜¯ç›®æ ‡è¯­(ä¸Š)ï¼Œç¬¬äºŒè¡Œæ˜¯æ¯è¯­(ä¸‹)
                    // æœ‰äº›å­—å¹•æ–‡ä»¶å¯èƒ½å¸¦æ ‡ç­¾ <font> ç­‰ï¼Œè¿™é‡Œç®€å•æ¸…æ´—ä¸€ä¸‹
                    fT = contentLines[0].replace(/<[^>]*>/g, ""); 
                    //å‰©ä¸‹çš„æ‰€æœ‰è¡Œåˆå¹¶ä¸ºç¬¬äºŒè¡Œ
                    nT = contentLines.slice(1).join(' ').replace(/<[^>]*>/g, ""); 
                }

                if (fT || nT) {
                    subtitles.push({s, e, f: fT, n: nT});
                }
            }
        }
    });
}
    function parseTime(t){ if(!t)return 0; const p=t.trim().replace(',','.').split(':'); return parseInt(p[0])*3600+parseInt(p[1])*60+parseFloat(p[2]); }

// ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šæ”¯æŒæ—¥è¯­/ä¸­æ–‡åˆ†è¯
function createInteractiveSpan(text, container) {
    if (!text) return;

    // æ£€æµ‹æ˜¯å¦åŒ…å«CJKå­—ç¬¦ (æ—¥æ–‡å‡åã€æ±‰å­—)
    const hasCJK = /[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/.test(text);

    if (hasCJK && typeof Intl !== 'undefined' && Intl.Segmenter) {
        // --- æ–¹æ¡ˆ A: ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿæ™ºèƒ½åˆ†è¯ (é€‚ç”¨äºç°ä»£æµè§ˆå™¨) ---
        // 'ja' åŒºåŸŸè®¾ç½®å¯¹ä¸­æ—¥æ–‡åˆ†è¯æ•ˆæœéƒ½ä¸é”™
        const segmenter = new Intl.Segmenter('ja', { granularity: 'word' });
        const segments = segmenter.segment(text);

        for (const { segment, isWordLike } of segments) {
            if (isWordLike || segment.trim().length > 0) {
                // å¦‚æœæ˜¯æ ‡ç‚¹ç¬¦å·ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ä¸åŠ ç‚¹å‡»äº‹ä»¶ï¼Œè¿™é‡Œç»Ÿä¸€åŠ ä¸Š
                createSpan(segment, container);
            }
        }
    } else {
        // --- æ–¹æ¡ˆ B: çº¯è‹±æ–‡ç¯å¢ƒæˆ–é™çº§å¤„ç† (åŸé€»è¾‘) ---
        // å¢åŠ å¯¹æ—¥è¯­æ ‡ç‚¹çš„åˆ†å‰²æ”¯æŒ
        const tokens = text.split(/([a-zA-Z0-9\-\']+|[\u3000-\u303f\uff01-\uff5e]+)/);
        tokens.forEach(part => {
            // åŒ¹é…è‹±æ–‡å•è¯ OR ä»»æ„éç©ºç™½çš„CJKå­—ç¬¦(å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒIntl)
            if (part.match(/[a-zA-Z0-9\-\']+/) || (hasCJK && part.trim())) {
                createSpan(part, container);
            } else {
                container.appendChild(document.createTextNode(part));
            }
        });
    }
}

// è¾…åŠ©å‡½æ•°ï¼šåˆ›å»º Span
function createSpan(word, container) {
    const sp = document.createElement('span');
    sp.className = 'word-click';
    sp.innerText = word;
    sp.onclick = (e) => { e.stopPropagation(); lookup(word); };
    container.appendChild(sp);
}

    function renderSubs() {
        const container = document.getElementById('page-subs');
        container.innerHTML = "";
        subtitles.forEach((s, i) => {
            const row = document.createElement('div');
            row.className = 'tp-row'; row.id = 'tp-'+i;
            
            // å·¦ä¾§ï¼šæ”¶è—å¥å­æŒ‰é’®
            const leftCol = document.createElement('div');
            leftCol.className = 'tp-left-col';
            const star = document.createElement('div');
            star.className = 'star-btn';
            star.innerHTML = 'â­';
            star.onclick = (e) => { e.stopPropagation(); addFav('sent', s.f); };
            leftCol.appendChild(star);

            const grp = document.createElement('div');
            grp.className = 'tp-text-group';

            const divTop = document.createElement('div'); divTop.className = 'tp-top-line';
            createInteractiveSpan(s.f, divTop); 

            const divBot = document.createElement('div'); divBot.className = 'tp-bottom-line';
            createInteractiveSpan(s.n, divBot);
            
            grp.appendChild(divTop); grp.appendChild(divBot);

            const btn = document.createElement('button');
            btn.className = 'tp-play-small'; btn.innerHTML = 'â–¶';
            btn.onclick = (e) => { e.stopPropagation(); if(player){ player.currentTime=s.s; player.play(); } };

            row.appendChild(leftCol); // æ”¶è—åœ¨å·¦
            row.appendChild(grp); 
            row.appendChild(btn);
            container.appendChild(row);
        });
    }

async function lookup(w) {
    if(!w) return;
    // å»é™¤ä¸€äº›æ ‡ç‚¹ç¬¦å·ï¼Œé¿å…æŸ¥è¯å¤±è´¥
    w = w.trim().replace(/[.,!?;:"'()ã€‚ï¼Œï¼ï¼Ÿã€]/g, "");
    if(!w) return;

    curHovWord = w;
    document.getElementById('hoverTip').style.display='block';
    document.getElementById('popWord').innerText = w;
    const defDiv = document.getElementById('popDef');
    defDiv.innerText = "æŸ¥è¯¢ä¸­...";

    // æ£€æŸ¥æœ¬åœ°ç¼“å­˜
    const exist = favData.words.find(x=>x.t.toLowerCase()===w.toLowerCase());
    if(exist) { defDiv.innerHTML = `<b style="color:#4CAF50">å·²æ”¶è—:</b> ${exist.d}`; return; }

    if(HAS_API) {
        try {
            const appid = APP_CONFIG.baidu.appid;
            const key = APP_CONFIG.baidu.key;
            const salt = (new Date).getTime();
            
            // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šfrom=auto (è‡ªåŠ¨è¯†åˆ«æºè¯­è¨€)
            // ç›®æ ‡è¯­è¨€ä¿æŒ zh (ä¸­æ–‡)ï¼Œå¦‚æœä½ æƒ³äº’è¯‘å¯ä»¥æ ¹æ®é€»è¾‘è°ƒæ•´
            const sign = CryptoJS.MD5(appid + w + salt + key).toString();
            const url = `https://api.fanyi.baidu.com/api/trans/vip/translate?q=${encodeURIComponent(w)}&from=auto&to=zh&appid=${appid}&salt=${salt}&sign=${sign}`;
            
            const callbackName = 'baidu_cb_' + Math.floor(Math.random() * 100000);
            window[callbackName] = function(res) {
                if(res.trans_result) {
                    // æ˜¾ç¤ºåŸæ–‡è¯­ç§ (ä¾¿äºè°ƒè¯•)
                    const srcLang = res.from; 
                    const trans = res.trans_result.map(r=>`<div>${r.dst}</div>`).join('');
                    defDiv.innerHTML = `<span style="font-size:10px;color:#666">[${srcLang}â†’zh]</span><br>${trans}`;
                } else {
                    defDiv.innerText = "API é”™è¯¯: " + (res.error_code || "æœªçŸ¥");
                }
                delete window[callbackName];
                document.body.removeChild(script);
            };
            
            const script = document.createElement('script');
            script.src = `${url}&callback=${callbackName}`;
            document.body.appendChild(script);

        } catch(e) { 
            defDiv.innerText = "è¯·æ±‚é”™è¯¯";
            console.error(e);
        }
    } else {
        // æ³¨æ„ï¼šè¿™ä¸ªå…è´¹çš„è‹±æ–‡è¯å…¸APIä¸æ”¯æŒæ—¥è¯­ã€‚
        // å¦‚æœæ˜¯æ—¥è¯­ï¼Œå»ºè®®æç¤ºç”¨æˆ·é…ç½®ç™¾åº¦API
        if(/[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff]/.test(w)){
            defDiv.innerText = "æ—¥è¯­æŸ¥è¯¢è¯·å…ˆé…ç½®ç™¾åº¦ç¿»è¯‘API (ç‚¹å‡»å·¦ä¸Šè§’é”å›¾æ ‡)";
        } else {
            fallbackLookup(w, defDiv);
        }
    }
}
    
    function fallbackLookup(w, div) {
        fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${w}`)
            .then(r=>r.json()).then(d=>{
                if(d[0]) div.innerHTML = d[0].meanings[0].definitions[0].definition;
                else div.innerText = "æ— é‡Šä¹‰";
            }).catch(()=>div.innerText="æŸ¥è¯¢å¤±è´¥");
    }

    function saveFromPop() {
        if(curHovWord) {
            let d = document.getElementById('popDef').innerText;
            if(d.includes('æŸ¥è¯¢ä¸­')) d = "";
            addFav('word', curHovWord, d);
            document.getElementById('hoverTip').style.display='none';
        }
    }

    function renderFavList() {
        const wBox = document.getElementById('tab-content-words');
        wBox.innerHTML = favData.words.length ? "" : "<div class='empty-tip'>æš‚æ— å•è¯</div>";
        favData.words.forEach((w, i) => {
            const d = document.createElement('div'); d.className='fav-item';
            d.innerHTML = `<span class="fav-word">${w.t}</span><input class="fav-input" value="${w.d}" oninput="updWord(${i},this.value)"><span class="del-btn" onclick="delFav('word',${i})">Ã—</span>`;
            wBox.appendChild(d);
        });

        const sBox = document.getElementById('tab-content-sents');
        sBox.innerHTML = favData.sents.length ? "" : "<div class='empty-tip'>æš‚æ— å¥å­</div>";
        favData.sents.forEach((s, i) => {
            const d = document.createElement('div'); d.className='fav-item';
            d.innerHTML = `<span style="font-size:14px; color:#ddd; padding-right:20px;">${s.t}</span><span class="del-btn" onclick="delFav('sent',${i})">Ã—</span>`;
            sBox.appendChild(d);
        });
        document.getElementById('myNotebook').value = favData.noteContent || "";
    }

    function addFav(type, t, d="") {
        if(type==='word') favData.words.unshift({t, d}); else favData.sents.unshift({t, d});
        saveData(); renderFavList(); alert("å·²æ”¶è—");
    }
    function delFav(type, i) {
        if(type==='word') favData.words.splice(i,1); else favData.sents.splice(i,1);
        saveData(); renderFavList();
    }
    function updWord(i, v) { favData.words[i].d=v; saveData(); }
    
    function loadData() {
        const d = localStorage.getItem(currentFileKey);
        favData = d ? JSON.parse(d) : { words: [], sents: [], noteContent: "" };
        renderFavList();
    }
    function saveData() {
        favData.noteContent = document.getElementById('myNotebook').value;
        localStorage.setItem(currentFileKey, JSON.stringify(favData));
    }

    function doExport(type) {
        document.getElementById('modalExport').style.display='none';
        if(type==='backup') {
            download(JSON.stringify(favData), 'backup.json', 'text/plain');
        } else if(type==='txt') {
            let t="WORDS:\n"; favData.words.forEach(w=>t+=`${w.t}=${w.d}\n`);
            t+="\nSENTS:\n"; favData.sents.forEach(s=>t+=`${s.t}\n`);
            download(t, 'study.txt', 'text/plain');
        } else if(type==='excel') {
            let c="\uFEFFWord,Desc\n"; favData.words.forEach(w=>c+=`${w.t},"${w.d}"\n`);
            download(c, 'words.csv', 'text/csv');
        } else if(type==='pdf') {
            const area = document.getElementById('printArea');
            let h = "<h1 class='p-h1'>å­¦ä¹ è®°å½•</h1>";
            h += "<h2 class='p-h2'>å•è¯è¡¨</h2><table class='p-table'><thead><tr><th class='col-word'>å•è¯</th><th class='col-note'>è§£é‡Š/ç¬”è®°</th><th class='col-blank'>é»˜å†™</th></tr></thead><tbody>";
            favData.words.forEach(w => {
                h += `<tr><td style="font-weight:bold">${w.t}</td><td>${w.d}</td><td></td></tr>`;
            });
            h += "</tbody></table>";
            h += "<h2 class='p-h2'>é‡ç‚¹å¥</h2><table class='p-table'><thead><tr><th>å¥å­</th><th>ç¬”è®°</th></tr></thead><tbody>";
            favData.sents.forEach(s => {
                h += `<tr><td>${s.t}</td><td></td></tr>`;
            });
            h += "</tbody></table>";
            area.innerHTML = h;
            window.print();
        }
    }
    function download(c, n, t) { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([c],{type:t})); a.download=n; a.click(); }
    
    function importBackup() {
        const f=document.getElementById('importFile').files[0]; if(!f)return;
        const r=new FileReader(); r.onload=e=>{
            try { favData=JSON.parse(e.target.result); saveData(); renderFavList(); alert("âœ… å¯¼å…¥æˆåŠŸ"); document.getElementById('modalExport').style.display='none'; }
            catch(x){alert("æ ¼å¼é”™è¯¯");}
        }; r.readAsText(f);
    }

    function onTick() {
        if(!player) return;
        const t = player.currentTime;
        if(isLooping && loopEnd > loopStart && t >= loopEnd) { player.currentTime = loopStart; player.play(); return; }
        const sub = subtitles.find(s => t>=s.s && t<=s.e);
        if(sub) {
            const idx = subtitles.indexOf(sub);
            if(idx!==activeIndex) {
                if(activeIndex!==-1) document.getElementById('tp-'+activeIndex)?.classList.remove('active');
                activeIndex = idx;
                const el = document.getElementById('tp-'+idx);
                if(el) { el.classList.add('active'); el.scrollIntoView({behavior:'smooth', block:'center'}); }
            }
        }
    }
    function setA() { if(player) { loopStart=player.currentTime; document.getElementById('inA').value=loopStart.toFixed(1); } }
    function setB() { if(player) { loopEnd=player.currentTime; document.getElementById('inB').value=loopEnd.toFixed(1); } }
    function toggleLoop() {
        loopStart = parseFloat(document.getElementById('inA').value);
        loopEnd = parseFloat(document.getElementById('inB').value);
        if(loopEnd>loopStart) { isLooping=true; player.currentTime=loopStart; player.play(); document.getElementById('btnLoop').classList.add('btn-loop-active'); }
    }
    function clearLoop() { isLooping=false; document.getElementById('btnLoop').classList.remove('btn-loop-active'); }
    
    initApp();
</script>
</body>
</html>
