<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Shadowing Player Ultimate</title>
<style>
    /* =========================================
       1. å…¨å±€æ ·å¼é‡ç½®
       ========================================= */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
        margin: 0; padding: 0; 
        background: #000; color: #eee; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif; 
        height: 100vh; width: 100vw;
        overflow: hidden; /* ç¦æ­¢é¡µé¢æ•´ä½“æ»šåŠ¨ */
    }
    
    button { border: none; outline: none; background: #333; color: #ccc; border-radius: 4px; cursor: pointer; transition: 0.2s; }
    button:active { background: #555; }
    input { background: #111; border: 1px solid #444; color: #fff; text-align: center; border-radius: 4px; outline: none; }

    /* =========================================
       2. å¸ƒå±€æ¡†æ¶ (Mobile First -> PC Sidebar)
       ========================================= */
    
    /* æ‰‹æœºç«¯é»˜è®¤ï¼šä¸Šä¸‹ Flex ç»“æ„ */
    #layout-left {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 40%; /* è§†é¢‘å 40% */
        background: #000;
        border-bottom: 1px solid #333;
        z-index: 10;
        display: flex; flex-direction: column;
    }

    #layout-right {
        position: absolute;
        bottom: 0; left: 0;
        width: 100%; height: 60%; /* åˆ—è¡¨å 60% */
        background: #121212;
        z-index: 5;
        display: flex; flex-direction: column;
    }

    /* --- ğŸ’» ç”µè„‘ç«¯å¼ºåˆ¶å¸ƒå±€ (ç»å¯¹å®šä½ä¾§è¾¹æ ) --- */
    @media (min-width: 768px) {
        #layout-left {
            width: 65% !important; /* å·¦ä¾§è§†é¢‘å˜å®½ */
            height: 100% !important; 
            border-bottom: none !important;
            border-right: 1px solid #333;
        }
        #layout-right {
            top: 0; right: 0; left: auto; /* å¼ºåˆ¶å›ºå®šåœ¨å³ä¾§ */
            width: 35% !important; 
            height: 100% !important;
        }
    }

    /* =========================================
       3. å·¦ä¾§ç»„ä»¶ (é¡¶éƒ¨æ  + è§†é¢‘ + å¾ªç¯æ¡)
       ========================================= */
    .top-bar { 
        height: 44px; background: #1f1f1f; 
        display: flex; align-items: center; 
        padding: 0 10px; gap: 8px; 
        flex-shrink: 0; overflow-x: auto; 
    }
    .btn-tool { 
        padding: 6px 12px; font-size: 13px; 
        background: #2a2a2a; color: #ddd; 
        white-space: nowrap; 
        display: flex; align-items: center; gap: 4px;
    }

    .video-container { 
        flex: 1; position: relative; 
        display: flex; align-items: center; justify-content: center; 
        overflow: hidden; background: #000;
    }
    video, audio { width: 100%; height: 100%; object-fit: contain; }
    
    .loop-controls { 
        height: 48px; background: #111; 
        display: flex; align-items: center; justify-content: center; 
        gap: 8px; flex-shrink: 0; border-top: 1px solid #222;
    }
    .btn-circle { width: 32px; height: 32px; border-radius: 50%; background: #222; border: 1px solid #333; }
    .inp-time { width: 55px; height: 28px; font-size: 12px; }

    /* =========================================
       4. å³ä¾§ç»„ä»¶ (Tab + åˆ—è¡¨ + ç¬”è®°)
       ========================================= */
    .sidebar-tabs { 
        height: 44px; background: #1a1a1a; 
        display: flex; border-bottom: 1px solid #333; flex-shrink: 0; 
    }
    .tab-btn { 
        flex: 1; display: flex; align-items: center; justify-content: center; 
        font-size: 14px; color: #888; cursor: pointer; 
        border-bottom: 3px solid transparent; 
    }
    .tab-btn.active { color: #fff; background: #222; border-bottom-color: #4CAF50; font-weight: bold; }

    .scroll-content { 
        flex: 1; overflow-y: auto; overflow-x: hidden; 
        position: relative; 
    }
    
    .panel { display: none; height: 100%; }
    .panel.show { display: block; }

    /* =========================================
       5. å­—å¹•è¡Œæ ·å¼ (Blockå¸ƒå±€ï¼Œæœç»ç«–æ¡)
       ========================================= */
    .sub-row {
        display: flex; 
        flex-direction: row; /* å¼ºåˆ¶æ¨ªå‘ */
        align-items: flex-start;
        padding: 12px 10px;
        border-bottom: 1px solid #222;
        width: 100%;
        background: #121212;
    }
    .sub-row.active { background: #1e1e1e; border-left: 4px solid #4CAF50; }
    
    .row-left { width: 30px; padding-top: 2px; flex-shrink: 0; cursor: pointer; text-align: center; }
    
    .row-center { 
        flex: 1; margin: 0 10px; 
        display: flex; flex-direction: column; 
    }
    
    /* ä¸»å­—å¹• (ä¸Š) */
    .line-main { 
        color: #fff; font-size: 16px; 
        margin-bottom: 6px; line-height: 1.5; font-weight: 500;
    }
    /* å‰¯å­—å¹• (ä¸‹) */
    .line-sub { 
        color: #888; font-size: 14px; 
        line-height: 1.4; 
    }
    
    .row-right { width: 30px; flex-shrink: 0; padding-top: 2px; }
    .btn-play-mini { width: 28px; height: 28px; border-radius: 50%; background: #333; font-size: 10px; border: 1px solid #444; }

    /* å•è¯ç‚¹å‡»é«˜äº® */
    .w-clk { cursor: pointer; border-bottom: 1px solid transparent; display: inline; }
    .w-clk:hover { background: #333; border-bottom-color: #666; }
    ::selection { background: rgba(76, 175, 80, 0.5); color: white; }

    /* ç¬”è®°åŒº */
    textarea.note-box { width: 100%; height: 100%; background: #121212; border: none; padding: 20px; color: #ddd; font-size: 15px; resize: none; outline: none; line-height: 1.6; }

    /* =========================================
       6. å¼¹çª—æ ·å¼
       ========================================= */
    #pop-card { 
        display: none; position: fixed; 
        top: 50%; left: 50%; transform: translate(-50%, -50%); 
        width: 85%; max-width: 320px; 
        background: #252525; padding: 20px; 
        border-radius: 8px; border: 1px solid #444; 
        z-index: 100; box-shadow: 0 10px 40px rgba(0,0,0,0.8); 
    }
    .dict-links { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #444; display: flex; gap: 10px; flex-wrap: wrap; }
    .dict-btn { color: #FFC107; text-decoration: none; font-size: 12px; border: 1px solid #555; padding: 4px 8px; border-radius: 4px; }
    
</style>
</head>
<body>

    <div id="pop-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 id="pop-word" style="color:#4CAF50; margin:0;">Word</h3>
            <span onclick="document.getElementById('pop-card').style.display='none'" style="cursor:pointer; color:#888;">âœ•</span>
        </div>
        <div id="pop-def" style="color:#ccc; font-size:14px; line-height:1.5;">æŸ¥è¯¢ä¸­...</div>
    </div>

    <div id="layout-left">
        <div class="top-bar">
            <button class="btn-tool" onclick="document.getElementById('fVid').click()">ğŸ“‚ è§†é¢‘</button>
            <button class="btn-tool" onclick="document.getElementById('fSubMain').click()">ğŸ‡¯ğŸ‡µ ä¸»å­—å¹•</button>
            <button class="btn-tool" onclick="document.getElementById('fSubSec').click()">ğŸ‡¨ğŸ‡³ å‰¯å­—å¹•</button>
            <button class="btn-tool" onclick="swapLang()">â‡… äº¤æ¢</button>
            
            <input type="file" id="fVid" hidden accept="video/*,audio/*">
            <input type="file" id="fSubMain" hidden accept=".srt,.ass,.vtt">
            <input type="file" id="fSubSec" hidden accept=".srt,.ass,.vtt">
        </div>

        <div class="video-container">
            <div id="vid-placeholder" style="color:#666; font-size:14px;">è¯·ç‚¹å‡»å·¦ä¸Šè§’å¯¼å…¥è§†é¢‘</div>
            <video id="vid" hidden playsinline controls></video>
            <audio id="aud" hidden controls></audio>
        </div>

        <div class="loop-controls">
            <button class="btn-circle" onclick="setA()">A</button>
            <input id="inA" class="inp-time" value="0.0">
            <span style="color:#666">-</span>
            <input id="inB" class="inp-time" value="0.0">
            <button class="btn-circle" onclick="setB()">B</button>
            <button class="btn-circle" id="btnLoop" onclick="toggleLoop()">ğŸ”</button>
        </div>
    </div>

    <div id="layout-right">
        <div class="sidebar-tabs">
            <div class="tab-btn active" onclick="switchTab('subs', this)">ğŸ“ å­—å¹•åˆ—è¡¨</div>
            <div class="tab-btn" onclick="switchTab('notes', this)">ğŸ“’ å­¦ä¹ ç¬”è®°</div>
        </div>

        <div class="scroll-content">
            <div id="panel-subs" class="panel show">
                <div style="padding:40px; text-align:center; color:#555; font-size:13px; line-height:2;">
                    æš‚æ— å­—å¹•<br>æ”¯æŒå¯¼å…¥å•æ–‡ä»¶(åŒè¯­)æˆ–åŒæ–‡ä»¶
                </div>
            </div>

            <div id="panel-notes" class="panel">
                <textarea id="notebook" class="note-box" placeholder="åœ¨æ­¤è®°å½•ç”Ÿè¯å’Œç¬”è®° (è‡ªåŠ¨ä¿å­˜)..." oninput="saveNote()"></textarea>
            </div>
        </div>
    </div>

<script>
    // === å…¨å±€å˜é‡ ===
    let player = null;
    let subtitles = [];
    let rawMain = null; // ä¸»å­—å¹•æ•°æ®
    let rawSec = null;  // å‰¯å­—å¹•æ•°æ®
    let loopStart=0, loopEnd=0, looping=false;

    // === 1. ç•Œé¢é€»è¾‘ ===
    function switchTab(target, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('show'));
        document.getElementById('panel-' + target).classList.add('show');
    }

    // === 2. åª’ä½“å¯¼å…¥ ===
    document.getElementById('fVid').onchange = function(e) {
        const f = e.target.files[0]; if(!f) return;
        document.getElementById('vid-placeholder').style.display = 'none';
        
        const v = document.getElementById('vid');
        const a = document.getElementById('aud');
        v.style.display = 'none'; a.style.display = 'none';

        if(f.name.match(/\.(mp3|wav|m4a)$/i)) { player = a; } else { player = v; }
        
        player.style.display = 'block';
        player.src = URL.createObjectURL(f);
        player.ontimeupdate = onTick;
    };

    // === 3. å­—å¹•å¯¼å…¥ (æ”¯æŒä¸»/å‰¯) ===
    document.getElementById('fSubMain').onchange = e => loadSub(e.target.files[0], true);
    document.getElementById('fSubSec').onchange = e => loadSub(e.target.files[0], false);

    function loadSub(f, isMain) {
        if(!f) return;
        const r = new FileReader();
        r.onload = ev => {
            // è§£ææ—¶ä¼ å…¥æ ‡å¿—ï¼Œå•æ–‡ä»¶è§£æå™¨ä¼šæ›´æ™ºèƒ½
            const arr = parseSRT(ev.target.result);
            if(isMain) { 
                rawMain = arr; 
                alert(`ä¸»å­—å¹•åŠ è½½æˆåŠŸ: ${arr.length} è¡Œ`);
            } else { 
                rawSec = arr; 
                alert(`å‰¯å­—å¹•åŠ è½½æˆåŠŸ: ${arr.length} è¡Œ`);
            }
            mergeAndRender();
        };
        r.readAsText(f);
    }

    // === 4. æ™ºèƒ½å­—å¹•è§£æ (ä¿®å¤ï¼šå•æ–‡ä»¶åŒè¯­è¯†åˆ« + è‹±æ–‡é˜²ç²˜è¿) ===
    function parseSRT(txt) {
        let res = [];
        txt = txt.replace(/\r\n/g, '\n'); // ç»Ÿä¸€æ¢è¡Œç¬¦
        const blocks = txt.split(/\n\s*\n/); // æŒ‰ç©ºè¡Œåˆ†å‰²

        blocks.forEach(blk => {
            const lines = blk.split('\n');
            if (lines.length >= 2) {
                // æ‰¾æ—¶é—´è½´
                const tIndex = lines.findIndex(l => l.includes('-->'));
                if (tIndex !== -1) {
                    const times = lines[tIndex].split('-->');
                    const s = parseT(times[0]); 
                    const e = parseT(times[1]);

                    // æå–æ‰€æœ‰æ–‡æœ¬è¡Œ (å»æ‰æ ‡ç­¾ï¼Œå»æ‰ç©ºè¡Œ)
                    let contentLines = lines.slice(tIndex + 1)
                        .map(l => l.replace(/<[^>]+>/g, "").trim())
                        .filter(l => l);

                    if (contentLines.length > 0) {
                        // é€»è¾‘ï¼šç¬¬ä¸€è¡Œå¿…å®šæ˜¯ Main
                        let mainT = contentLines[0];
                        let secT = "";

                        // å¦‚æœæœ‰å¤šè¡Œï¼Œå‰©ä¸‹çš„åˆå¹¶ä¸º Sub (ç”¨ç©ºæ ¼è¿æ¥ï¼Œé˜²æ­¢å•è¯ç²˜è¿)
                        if (contentLines.length > 1) {
                            secT = contentLines.slice(1).join(' '); 
                        }
                        
                        res.push({ s, e, m: mainT, c: secT });
                    }
                }
            }
        });
        return res;
    }
    
    function parseT(tStr) {
        if(!tStr) return 0;
        const p = tStr.trim().replace(',', '.').split(':');
        return (parseInt(p[0])*3600) + (parseInt(p[1])*60) + parseFloat(p[2]);
    }

    // === 5. åˆå¹¶é€»è¾‘ (ä¿®å¤ï¼šä¼˜å…ˆä¿ç•™å•æ–‡ä»¶ä¸­çš„åŒè¯­) ===
    function mergeAndRender() {
        if (!rawMain && !rawSec) return;

        // åœºæ™¯A: åªæœ‰ä¸»æ–‡ä»¶
        if (rawMain && !rawSec) {
            subtitles = rawMain; 
        } 
        // åœºæ™¯B: åªæœ‰å‰¯æ–‡ä»¶
        else if (!rawMain && rawSec) {
            subtitles = rawSec.map(i => ({ s:i.s, e:i.e, m:i.m, c:"" }));
        } 
        // åœºæ™¯C: ä¸¤ä¸ªéƒ½æœ‰ -> åˆå¹¶
        else {
            subtitles = rawMain.map(item => {
                let mainText = item.m; 
                let secText = "";

                // å…ˆçœ‹å‰¯æ–‡ä»¶é‡Œæœ‰æ²¡æœ‰å¯¹åº”æ—¶é—´çš„
                const mid = (item.s + item.e) / 2;
                const match = rawSec.find(x => mid >= x.s && mid <= x.e);
                
                if (match) {
                    secText = match.m; // æ‰¾åˆ°äº†ï¼Œç”¨å‰¯æ–‡ä»¶çš„ç¬¬ä¸€è¡Œ
                } else {
                    secText = item.c; // æ²¡æ‰¾åˆ°ï¼Œç”¨ä¸»æ–‡ä»¶è‡ªå¸¦çš„ç¬¬äºŒè¡Œ(å¦‚æœæœ‰)
                }
                return { s: item.s, e: item.e, m: mainText, c: secText };
            });
        }
        renderList();
    }
    
    function swapLang() {
        subtitles.forEach(s => { let t = s.m; s.m = s.c; s.c = t; });
        renderList();
    }

    // === 6. æ¸²æŸ“åˆ—è¡¨ (æ”¯æŒåŒè¯­ç‚¹å‡») ===
    function renderList() {
        const box = document.getElementById('panel-subs');
        box.innerHTML = "";

        subtitles.forEach((sub, idx) => {
            const div = document.createElement('div');
            div.className = 'sub-row';
            div.id = 'row-' + idx;

            // æ˜Ÿæ˜Ÿ
            div.innerHTML += `<div class="row-left" onclick="alert('å·²åŠ å…¥ç”Ÿè¯æœ¬')">â­</div>`;

            // ä¸­é—´æ–‡æœ¬
            const mid = document.createElement('div');
            mid.className = 'row-center';
            
            // ä¸Šå¥ (Main)
            const lineM = document.createElement('div'); 
            lineM.className = 'line-main';
            processText(sub.m, lineM); 
            mid.appendChild(lineM);

            // ä¸‹å¥ (Sub) - åªæœ‰æœ‰å†…å®¹æ‰æ¸²æŸ“
            if(sub.c && sub.c.trim()) {
                const lineS = document.createElement('div'); 
                lineS.className = 'line-sub';
                processText(sub.c, lineS); // è®©ä¸‹å¥ä¹Ÿæ”¯æŒæŸ¥è¯
                mid.appendChild(lineS);
            }

            div.appendChild(mid);

            // æ’­æ”¾æŒ‰é’®
            div.innerHTML += `<div class="row-right"><button class="btn-play-mini" onclick="seek(${sub.s})">â–¶</button></div>`;
            box.appendChild(div);
        });
    }

    // === 7. æ™ºèƒ½åˆ†è¯ä¸ç‚¹å‡» (ä¿®å¤ï¼šè‹±æ–‡ç©ºæ ¼) ===
    function processText(text, container) {
        if(!text) return;
        const isCJK = /[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff]/.test(text);

        if (isCJK && typeof Intl !== 'undefined' && Intl.Segmenter) {
            // æ—¥è¯­/ä¸­æ–‡ï¼šä½¿ç”¨åŸç”Ÿæ™ºèƒ½åˆ†è¯
            const seg = new Intl.Segmenter('ja', { granularity: 'word' });
            for (const { segment, isWordLike } of seg.segment(text)) {
                if (isWordLike || segment.trim().length > 0) {
                    createSpan(segment, container);
                }
            }
        } else {
            // è‹±æ–‡/å…¶ä»–ï¼šæŒ‰ç©ºæ ¼åˆ†å‰²ï¼Œå¹¶æ‰‹åŠ¨è¡¥ç©ºæ ¼
            const parts = text.split(' ');
            parts.forEach((p, i) => {
                createSpan(p, container);
                // é™¤éæ˜¯æœ€åä¸€ä¸ªè¯ï¼Œå¦åˆ™è¡¥ä¸€ä¸ªç©ºæ ¼æ–‡æœ¬èŠ‚ç‚¹
                if (i < parts.length - 1) {
                    container.appendChild(document.createTextNode(' '));
                }
            });
        }
    }

    function createSpan(w, parent) {
        const s = document.createElement('span');
        s.className = 'w-clk';
        s.innerText = w;
        s.onclick = (e) => { e.stopPropagation(); popupSearch(w); };
        parent.appendChild(s);
    }

    // === 8. æŸ¥è¯å¼¹çª— (å«å¤–éƒ¨é“¾æ¥) ===
    function popupSearch(w) {
        w = w.replace(/[.,!?;:"'()ã€‚ï¼Œï¼ï¼Ÿã€]/g, ""); // æ¸…æ´—æ ‡ç‚¹
        if(!w) return;

        const pop = document.getElementById('pop-card');
        pop.style.display = 'block';
        document.getElementById('pop-word').innerText = w;
        
        const links = `
            <div class="dict-links">
                <a href="https://www.mojidict.com/search/${encodeURIComponent(w)}" target="_blank" class="dict-btn">Mojiè¾ä¹¦</a>
                <a href="https://ejje.weblio.jp/content/${encodeURIComponent(w)}" target="_blank" class="dict-btn">Weblio</a>
                <a href="https://jisho.org/search/${encodeURIComponent(w)}" target="_blank" class="dict-btn">Jisho</a>
            </div>
        `;
        document.getElementById('pop-def').innerHTML = "ç‚¹å‡»ä¸‹æ–¹é“¾æ¥æŸ¥çœ‹è¯¦æƒ…ï¼š" + links;
    }
    
    // åˆ’è¯ç›‘å¬
    document.addEventListener('mouseup', function(e) {
        const sel = window.getSelection().toString().trim();
        const panel = document.getElementById('panel-subs');
        if(sel && panel.contains(e.target)) {
            popupSearch(sel);
        }
    });

    // === 9. æ’­æ”¾ä¸å¾ªç¯ ===
    function seek(t) { if(player) { player.currentTime = t; player.play(); } }
    
    function onTick() {
        if(!player) return;
        const t = player.currentTime;
        
        if(looping && t >= loopEnd) { player.currentTime = loopStart; return; }

        // é«˜äº®æ»šåŠ¨
        const idx = subtitles.findIndex(s => t >= s.s && t <= s.e);
        if(idx !== -1) {
            const old = document.querySelector('.sub-row.active');
            if(old) old.classList.remove('active');
            
            const cur = document.getElementById('row-' + idx);
            if(cur) {
                cur.classList.add('active');
                cur.scrollIntoView({behavior: "smooth", block: "center"});
            }
        }
    }

    function setA() { if(player) { loopStart=player.currentTime; document.getElementById('inA').value=loopStart.toFixed(1); } }
    function setB() { if(player) { loopEnd=player.currentTime; document.getElementById('inB').value=loopEnd.toFixed(1); } }
    function toggleLoop() { 
        looping = !looping; 
        document.getElementById('btnLoop').style.background = looping ? '#1565C0' : '#222';
    }

    // === 10. ç¬”è®°ä¿å­˜ ===
    function saveNote() { localStorage.setItem("SH_NOTE", document.getElementById('notebook').value); }
    window.onload = function() {
        const n = localStorage.getItem("SH_NOTE");
        if(n) document.getElementById('notebook').value = n;
    }

</script>
</body>
</html>
